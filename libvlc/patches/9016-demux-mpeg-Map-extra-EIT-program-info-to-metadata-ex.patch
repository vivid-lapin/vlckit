From 4a78020fa2fc642948677653d0b90450bbe6c17b Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Tue, 17 Feb 2026 21:30:23 +0900
Subject: [PATCH] demux/mpeg: Map extra EIT program info to metadata extra
 fields tmp

---
 src/input/es_out.c | 24 ++++++++++++++++--------
 1 file changed, 16 insertions(+), 8 deletions(-)

diff --git a/src/input/es_out.c b/src/input/es_out.c
index df0b0c27bc..c16b118e16 100644
--- a/src/input/es_out.c
+++ b/src/input/es_out.c
@@ -2073,21 +2073,26 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
                 p_pgrm->p_meta = vlc_meta_New();
             if( p_pgrm->p_meta )
             {
-                char psz_date[64];
+                char psz_program_start[32];
+                char psz_program_duration[32];
 
                 vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
                 vlc_meta_Set( p_pgrm->p_meta, vlc_meta_Description, psz_short_desc );
                 if( p_current != NULL )
                 {
-                    snprintf( psz_date, sizeof(psz_date),
-                              "start=%"PRId64";duration=%"PRIu32,
-                              p_current->i_start, p_current->i_duration );
-                    vlc_meta_SetDate( p_pgrm->p_meta, psz_date );
+                    snprintf( psz_program_start, sizeof(psz_program_start),
+                              "%"PRId64, p_current->i_start );
+                    snprintf( psz_program_duration, sizeof(psz_program_duration),
+                              "%"PRIu32, p_current->i_duration );
+                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", psz_program_start );
+                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", psz_program_duration );
                 }
                 else
                 {
-                    vlc_meta_SetDate( p_pgrm->p_meta, NULL );
+                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", NULL );
+                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", NULL );
                 }
+                vlc_meta_SetDate( p_pgrm->p_meta, NULL );
 
                 EsOutMetaClearPrefixedExtras( p_pgrm->p_meta, ARIB_META_EXTRA_PREFIX );
                 if( p_current != NULL )
@@ -2124,13 +2129,16 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
         const char *psz_desc = p_pgrm->p_meta ?
                                vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Description ) : NULL;
         input_item_SetDescription( input_priv(p_input)->p_item, psz_desc );
-        input_item_SetDate( input_priv(p_input)->p_item,
-                            p_pgrm->p_meta ? vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Date ) : NULL );
+        input_item_SetDate( input_priv(p_input)->p_item, NULL );
 
         /* Also propagate Publisher (service name from SDT) if available */
         const char *psz_pub = p_pgrm->p_meta ?
                               vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Publisher ) : NULL;
         input_item_SetPublisher( input_priv(p_input)->p_item, psz_pub );
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ProgramStartAt",
+                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ProgramStartAt" ) : NULL );
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ProgramDuration",
+                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ProgramDuration" ) : NULL );
 
         EsOutInputItemClearPrefixedExtras( input_priv(p_input)->p_item, ARIB_META_EXTRA_PREFIX );
         if( p_pgrm->p_meta )
-- 
2.39.1

