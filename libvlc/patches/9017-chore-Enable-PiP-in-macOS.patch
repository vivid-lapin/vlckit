From 5db21bd6d6cedb4f13e3a2883ed0cd84f9cffbba Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Mon, 23 Feb 2026 23:54:25 +0900
Subject: [PATCH] chore: Enable PiP in macOS

---
 modules/video_output/Makefile.am              |  9 ++++++++-
 .../apple/VLCPictureInPictureController.m     | 19 +++++++++++++++++++
 modules/video_output/apple/meson.build        | 14 ++++++++++++++
 3 files changed, 41 insertions(+), 1 deletion(-)

diff --git a/modules/video_output/Makefile.am b/modules/video_output/Makefile.am
index 62808377ed..ed6f4adb13 100644
--- a/modules/video_output/Makefile.am
+++ b/modules/video_output/Makefile.am
@@ -94,13 +94,20 @@ vout_LTLIBRARIES += libsamplebufferdisplay_plugin.la
 endif
 endif

-if HAVE_IOS_OR_TVOS
+if HAVE_DARWIN
+if !HAVE_WATCHOS
 libpictureinpicturecontroller_plugin_la_SOURCES = video_output/apple/VLCPictureInPictureController.m
 libpictureinpicturecontroller_plugin_la_OBJCFLAGS = $(AM_OBJCFLAGS) -fobjc-arc
+if HAVE_OSX
+libpictureinpicturecontroller_plugin_la_LDFLAGS = $(AM_LDFLAGS) -rpath '$(voutdir)' \
+	-Wl,-framework,AVFoundation,-framework,Foundation,-framework,AVKit,-framework,Cocoa,-framework,QuartzCore,-framework,CoreMedia
+else
 libpictureinpicturecontroller_plugin_la_LDFLAGS = $(AM_LDFLAGS) -rpath '$(voutdir)' \
 	-Wl,-framework,AVFoundation,-framework,Foundation,-framework,AVKit,-framework,UIKit,-framework,QuartzCore,-framework,CoreMedia
+endif
 vout_LTLIBRARIES += libpictureinpicturecontroller_plugin.la
 endif
+endif

 libvout_ios_plugin_la_SOURCES = video_output/opengl/display.c $(OPENGL_VOUT_COMMONSOURCES)
 libvout_ios_plugin_la_CFLAGS = $(AM_CFLAGS) $(OPENGL_COMMONCFLAGS) -DUSE_OPENGL_ES2
diff --git a/modules/video_output/apple/VLCPictureInPictureController.m b/modules/video_output/apple/VLCPictureInPictureController.m
index 7526f50a3f..8af8cf2830 100644
--- a/modules/video_output/apple/VLCPictureInPictureController.m
+++ b/modules/video_output/apple/VLCPictureInPictureController.m
@@ -226,6 +226,15 @@ API_AVAILABLE(ios(15.0), tvos(15.0), macosx(12.0))
 - (void)startPictureInPicture {
     AVPictureInPictureController *avPipController =
         (AVPictureInPictureController *)_avPipController;
+    if (!avPipController) {
+        msg_Err(_pipcontroller, "Cannot start PiP: controller is nil");
+        return;
+    }
+    if (@available(macOS 12.0, iOS 15.0, tvos 15.0, *)) {
+        if (!avPipController.isPictureInPicturePossible) {
+            msg_Err(_pipcontroller, "Cannot start PiP: isPictureInPicturePossible is false");
+        }
+    }
     [avPipController startPictureInPicture];
 }

@@ -241,6 +250,16 @@ API_AVAILABLE(ios(15.0), tvos(15.0), macosx(12.0))
     [avPipController invalidatePlaybackState];
 }

+- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController
+ failedToStartPictureInPictureWithError:(NSError *)error {
+    msg_Err(_pipcontroller, "PiP failed to start: %s", error.localizedDescription.UTF8String);
+}
+
+- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController
+restoreUserInterfaceForPictureInPictureStopWithCompletionHandler:(void (^)(BOOL restored))completionHandler {
+    completionHandler(YES);
+}
+
 @end

 static void SetDisplayLayer( pip_controller_t *pipcontroller, void *layer) {
diff --git a/modules/video_output/apple/meson.build b/modules/video_output/apple/meson.build
index a2f04f1e22..7bedea58a1 100644
--- a/modules/video_output/apple/meson.build
+++ b/modules/video_output/apple/meson.build
@@ -52,6 +52,20 @@ vlc_modules += {
     ],
 }

+vlc_modules += {
+    'name' : 'pictureinpicturecontroller',
+    'sources' : files('VLCPictureInPictureController.m'),
+    'objc_args' : ['-fobjc-arc'],
+    'dependencies' : [
+        frameworks['AVFoundation'],
+        frameworks['Foundation'],
+        frameworks['AVKit'],
+        uifwk_dep,
+        frameworks['QuartzCore'],
+        frameworks['CoreMedia'],
+    ],
+}
+
 if have_ios or have_tvos
     vlc_modules += {
         'name' : 'caeagl',
--
2.39.1

