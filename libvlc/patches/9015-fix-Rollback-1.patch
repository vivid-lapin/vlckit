From 335e9de0df98f6f7d313df4cd962fb38357641d3 Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Sun, 22 Feb 2026 23:20:12 +0900
Subject: [PATCH] fix: Rollback

---
 modules/demux/mpeg/ts_si.c | 26 ------------
 src/input/es_out.c         | 86 +++++++++++++-------------------------
 2 files changed, 30 insertions(+), 82 deletions(-)

diff --git a/modules/demux/mpeg/ts_si.c b/modules/demux/mpeg/ts_si.c
index d2b1d45526..a8feea113e 100644
--- a/modules/demux/mpeg/ts_si.c
+++ b/modules/demux/mpeg/ts_si.c
@@ -283,15 +283,7 @@ static void SDTCallBack( void *opaque, dvbpsi_sdt_t *p_sdt )
                 }
                 if (p_sys->standard == TS_STANDARD_ARIB)
                 {
-                    char psz_service_id[16];
-                    char psz_network_id[16];
-                    snprintf( psz_service_id, sizeof(psz_service_id),
-                              "%"PRIu16, p_srv->i_service_id );
-                    snprintf( psz_network_id, sizeof(psz_network_id),
-                              "%"PRIu16, p_sdt->i_network_id );
-                    vlc_meta_SetExtra( p_meta, "ServiceId", psz_service_id );
                     vlc_meta_SetExtra( p_meta, "ServiceName", str2 ? str2 : str1 );
-                    vlc_meta_SetExtra( p_meta, "ServiceNetworkId", psz_network_id );
                 }
                 free( str1 );
                 free( str2 );
@@ -403,7 +395,6 @@ static void TDTCallBack( void *opaque, dvbpsi_tot_t *p_tdt )
 {
     demux_t            *p_demux = opaque;
     demux_sys_t        *p_sys = p_demux->p_sys;
-    const bool          b_first_time_meta = ( p_sys->i_network_time_update == 0 );


     p_sys->i_network_time = EITConvertStartTime( p_tdt->i_utc_time );
@@ -425,23 +416,6 @@ static void TDTCallBack( void *opaque, dvbpsi_tot_t *p_tdt )
     dvbpsi_tot_delete(p_tdt);

     es_out_Control( p_demux->out, ES_OUT_SET_EPG_TIME, (int64_t) p_sys->i_network_time );
-
-    if( b_first_time_meta )
-    {
-        char psz_first_network_time[32];
-
-        if( snprintf( psz_first_network_time, sizeof(psz_first_network_time),
-                      "%"PRId64, (int64_t)p_sys->i_network_time ) > 0 )
-        {
-            vlc_meta_t *p_meta = vlc_meta_New();
-            if( p_meta )
-            {
-                vlc_meta_SetExtra( p_meta, "FirstNetworkTime", psz_first_network_time );
-                es_out_Control( p_demux->out, ES_OUT_SET_GROUP_META, -1, p_meta );
-                vlc_meta_Delete( p_meta );
-            }
-        }
-    }
 }

 typedef struct
diff --git a/src/input/es_out.c b/src/input/es_out.c
index a21a30148c..8cf552ef42 100644
--- a/src/input/es_out.c
+++ b/src/input/es_out.c
@@ -1639,8 +1639,11 @@ static void EsOutProgramSelect(es_out_sys_t *p_sys, es_out_pgrm_t *p_pgrm)
     /* Update now playing */
     if( p_pgrm->p_meta )
     {
+        const char *psz_nowplaying = vlc_meta_Get( p_pgrm->p_meta, vlc_meta_ESNowPlaying );
+
         input_item_SetESNowPlaying( input_priv(p_input)->p_item,
-                                    vlc_meta_Get( p_pgrm->p_meta, vlc_meta_ESNowPlaying ) );
+                                    psz_nowplaying );
+        input_item_SetNowPlaying( input_priv(p_input)->p_item, psz_nowplaying );
         input_item_SetPublisher( input_priv(p_input)->p_item,
                                  vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Publisher ) );
         input_item_SetTitle( input_priv(p_input)->p_item,
@@ -1848,8 +1851,7 @@ static void EsOutProgramMeta(es_out_sys_t *p_sys, input_source_t *source,
     /* Check against empty meta data (empty for what we handle) */
     if( !vlc_meta_Get( p_meta, vlc_meta_Title) &&
         !vlc_meta_Get( p_meta, vlc_meta_ESNowPlaying) &&
-        !vlc_meta_Get( p_meta, vlc_meta_Publisher) &&
-        vlc_meta_GetExtraCount( p_meta ) == 0 )
+        !vlc_meta_Get( p_meta, vlc_meta_Publisher) )
     {
         return;
     }
@@ -1979,7 +1981,7 @@ static void EsOutProgramEpgEvent(es_out_sys_t *p_sys, input_source_t *source,
     input_item_SetEpgEvent( p_item, p_event );
 }

-#define ARIB_META_EXTRA_PREFIX "PresentEventItems:"
+#define ARIB_META_EXTRA_PREFIX "ARIB:"

 static bool EsOutMetaExtraHasPrefix(const char *psz_name, const char *psz_prefix)
 {
@@ -2052,13 +2054,6 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,

     free( epg.psz_name );

-    /* Update now playing */
-    if( p_epg->b_present && p_pgrm->p_meta &&
-       ( p_epg->p_current || p_epg->i_event == 0 ) )
-    {
-        vlc_meta_SetNowPlaying( p_pgrm->p_meta, NULL );
-    }
-
     const vlc_epg_event_t *p_current = NULL;
     vlc_mutex_lock( &p_item->lock );
     if( p_item->p_epg_table != NULL &&
@@ -2069,12 +2064,12 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
     }
     else
     {
-    for( int i = 0; i < p_item->i_epg; i++ )
-    {
-        const vlc_epg_t *p_tmp = p_item->pp_epg[i];
-
-        if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
+        for( int i = 0; i < p_item->i_epg; i++ )
         {
+            const vlc_epg_t *p_tmp = p_item->pp_epg[i];
+
+            if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
+            {
                 p_current = p_tmp->p_current;
                 break;
             }
@@ -2088,27 +2083,25 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
         p_pgrm->p_meta = vlc_meta_New();
     if( p_pgrm->p_meta )
     {
-        vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
-
-        char psz_event_start[32];
-        char psz_event_duration[32];
+        char psz_program_start[32];
+        char psz_program_duration[32];

         vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventName", psz_name );
-        vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventDesc", psz_short_desc );
+        vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventShortDescriptor", psz_short_desc );
         if( p_current != NULL )
         {
-            snprintf( psz_event_start, sizeof(psz_event_start),
+            snprintf( psz_program_start, sizeof(psz_program_start),
                       "%"PRId64, p_current->i_start );
-            snprintf( psz_event_duration, sizeof(psz_event_duration),
+            snprintf( psz_program_duration, sizeof(psz_program_duration),
                       "%"PRIu32, p_current->i_duration );
-            vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventStartAt", psz_event_start );
-            vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventDuration", psz_event_duration );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", psz_program_start );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", psz_program_duration );
         }
         else
         {
-            vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventStartAt", NULL );
-            vlc_meta_SetExtra( p_pgrm->p_meta, "PresentEventDuration", NULL );
-    }
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", NULL );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", NULL );
+        }
         vlc_meta_SetDate( p_pgrm->p_meta, NULL );

         EsOutMetaClearPrefixedExtras( p_pgrm->p_meta, ARIB_META_EXTRA_PREFIX );
@@ -2133,20 +2126,17 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
     /* Update selected program input info */
     if( p_pgrm == p_sys->p_pgrm )
     {
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ServiceId",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ServiceId" ) : NULL );
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ServiceName",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ServiceName" ) : NULL );
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ServiceNetworkId",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ServiceNetworkId" ) : NULL );
+        const char *psz_service_name = p_pgrm->p_meta ?
+                                       vlc_meta_GetExtra( p_pgrm->p_meta, "ServiceName" ) : NULL;
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ServiceName", psz_service_name );
         input_item_SetMetaExtra( input_priv(p_input)->p_item, "PresentEventName",
                                  p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "PresentEventName" ) : NULL );
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "PresentEventDesc",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "PresentEventDesc" ) : NULL );
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "PresentEventStartAt",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "PresentEventStartAt" ) : NULL );
-        input_item_SetMetaExtra( input_priv(p_input)->p_item, "PresentEventDuration",
-                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "PresentEventDuration" ) : NULL );
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "PresentEventShortDescriptor",
+                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "PresentEventShortDescriptor" ) : NULL );
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ProgramStartAt",
+                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ProgramStartAt" ) : NULL );
+        input_item_SetMetaExtra( input_priv(p_input)->p_item, "ProgramDuration",
+                                 p_pgrm->p_meta ? vlc_meta_GetExtra( p_pgrm->p_meta, "ProgramDuration" ) : NULL );

         EsOutInputItemClearPrefixedExtras( input_priv(p_input)->p_item, ARIB_META_EXTRA_PREFIX );
         if( p_pgrm->p_meta )
@@ -2166,23 +2156,7 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
                 free( ppsz_extra_names );
             }
         }
-        const char *psz_nowplaying = p_pgrm->p_meta ?
-                                     vlc_meta_Get( p_pgrm->p_meta, vlc_meta_ESNowPlaying ) : NULL;
-
-        input_item_SetESNowPlaying( input_priv(p_input)->p_item, psz_nowplaying );
         input_SendEventMeta( p_input );
-
-        const char *now_playing_tr =
-            vlc_meta_TypeToLocalizedString(vlc_meta_ESNowPlaying);
-        int ret;
-        if( psz_nowplaying )
-            ret = input_item_AddInfo( p_item, psz_cat, now_playing_tr,
-                                      "%s", psz_nowplaying );
-        else
-            ret = input_item_DelInfo( p_item, psz_cat, now_playing_tr );
-
-        if( ret == VLC_SUCCESS )
-            input_SendEventMetaInfo( p_input );
     }

     free( psz_cat );
--
2.39.1

