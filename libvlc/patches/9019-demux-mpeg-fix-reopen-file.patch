From 59bf45118972c3ea35ffc4d4ed5c1d9f9b7e02b4 Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Wed, 18 Feb 2026 01:26:34 +0900
Subject: [PATCH] demux/mpeg: fix reopen file

---
 src/input/es_out.c | 114 +++++++++++++++++++++++++--------------------
 1 file changed, 64 insertions(+), 50 deletions(-)

diff --git a/src/input/es_out.c b/src/input/es_out.c
index c16b118e16..1d13dab2fd 100644
--- a/src/input/es_out.c
+++ b/src/input/es_out.c
@@ -1639,8 +1639,11 @@ static void EsOutProgramSelect(es_out_sys_t *p_sys, es_out_pgrm_t *p_pgrm)
     /* Update now playing */
     if( p_pgrm->p_meta )
     {
+        const char *psz_nowplaying = vlc_meta_Get( p_pgrm->p_meta, vlc_meta_ESNowPlaying );
+
         input_item_SetESNowPlaying( input_priv(p_input)->p_item,
-                                    vlc_meta_Get( p_pgrm->p_meta, vlc_meta_ESNowPlaying ) );
+                                    psz_nowplaying );
+        input_item_SetNowPlaying( input_priv(p_input)->p_item, psz_nowplaying );
         input_item_SetPublisher( input_priv(p_input)->p_item,
                                  vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Publisher ) );
         input_item_SetTitle( input_priv(p_input)->p_item,
@@ -2056,66 +2059,77 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
     if( p_epg->b_present && p_pgrm->p_meta &&
        ( p_epg->p_current || p_epg->i_event == 0 ) )
     {
-        vlc_meta_SetNowPlaying( p_pgrm->p_meta, NULL );
+        vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, NULL );
     }
 
+    const vlc_epg_event_t *p_current = NULL;
     vlc_mutex_lock( &p_item->lock );
-    for( int i = 0; i < p_item->i_epg; i++ )
+    if( p_item->p_epg_table != NULL &&
+        p_item->p_epg_table->b_present &&
+        p_item->p_epg_table->i_source_id == p_pgrm->i_id )
     {
-        const vlc_epg_t *p_tmp = p_item->pp_epg[i];
-
-        if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
+        p_current = p_item->p_epg_table->p_current;
+    }
+    else
+    {
+        for( int i = 0; i < p_item->i_epg; i++ )
         {
-            const vlc_epg_event_t *p_current = p_tmp->p_current;
-            const char *psz_name = ( p_current ) ? p_current->psz_name : NULL;
-            const char *psz_short_desc = ( p_current ) ? p_current->psz_short_description : NULL;
-            if( !p_pgrm->p_meta )
-                p_pgrm->p_meta = vlc_meta_New();
-            if( p_pgrm->p_meta )
+            const vlc_epg_t *p_tmp = p_item->pp_epg[i];
+
+            if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
             {
-                char psz_program_start[32];
-                char psz_program_duration[32];
+                p_current = p_tmp->p_current;
+                break;
+            }
+        }
+    }
+    vlc_mutex_unlock( &p_item->lock );
 
-                vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
-                vlc_meta_Set( p_pgrm->p_meta, vlc_meta_Description, psz_short_desc );
-                if( p_current != NULL )
-                {
-                    snprintf( psz_program_start, sizeof(psz_program_start),
-                              "%"PRId64, p_current->i_start );
-                    snprintf( psz_program_duration, sizeof(psz_program_duration),
-                              "%"PRIu32, p_current->i_duration );
-                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", psz_program_start );
-                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", psz_program_duration );
-                }
-                else
-                {
-                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", NULL );
-                    vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", NULL );
-                }
-                vlc_meta_SetDate( p_pgrm->p_meta, NULL );
+    const char *psz_name = ( p_current ) ? p_current->psz_name : NULL;
+    const char *psz_short_desc = ( p_current ) ? p_current->psz_short_description : NULL;
+    if( !p_pgrm->p_meta )
+        p_pgrm->p_meta = vlc_meta_New();
+    if( p_pgrm->p_meta )
+    {
+        char psz_program_start[32];
+        char psz_program_duration[32];
 
-                EsOutMetaClearPrefixedExtras( p_pgrm->p_meta, ARIB_META_EXTRA_PREFIX );
-                if( p_current != NULL )
-                {
-                    for( int j = 0; j < p_current->i_description_items; j++ )
-                    {
-                        const char *psz_key = p_current->description_items[j].psz_key;
-                        const char *psz_value = p_current->description_items[j].psz_value;
-                        char *psz_extra_name = NULL;
-
-                        if( psz_key == NULL || psz_value == NULL || *psz_key == '\0' )
-                            continue;
-                        if( asprintf( &psz_extra_name, ARIB_META_EXTRA_PREFIX "%s", psz_key ) < 0 )
-                            continue;
-                        vlc_meta_SetExtra( p_pgrm->p_meta, psz_extra_name, psz_value );
-                        free( psz_extra_name );
-                    }
-                }
+        vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
+        vlc_meta_Set( p_pgrm->p_meta, vlc_meta_Description, psz_short_desc );
+        if( p_current != NULL )
+        {
+            snprintf( psz_program_start, sizeof(psz_program_start),
+                      "%"PRId64, p_current->i_start );
+            snprintf( psz_program_duration, sizeof(psz_program_duration),
+                      "%"PRIu32, p_current->i_duration );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", psz_program_start );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", psz_program_duration );
+        }
+        else
+        {
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramStartAt", NULL );
+            vlc_meta_SetExtra( p_pgrm->p_meta, "ProgramDuration", NULL );
+        }
+        vlc_meta_SetDate( p_pgrm->p_meta, NULL );
+
+        EsOutMetaClearPrefixedExtras( p_pgrm->p_meta, ARIB_META_EXTRA_PREFIX );
+        if( p_current != NULL )
+        {
+            for( int j = 0; j < p_current->i_description_items; j++ )
+            {
+                const char *psz_key = p_current->description_items[j].psz_key;
+                const char *psz_value = p_current->description_items[j].psz_value;
+                char *psz_extra_name = NULL;
+
+                if( psz_key == NULL || psz_value == NULL || *psz_key == '\0' )
+                    continue;
+                if( asprintf( &psz_extra_name, ARIB_META_EXTRA_PREFIX "%s", psz_key ) < 0 )
+                    continue;
+                vlc_meta_SetExtra( p_pgrm->p_meta, psz_extra_name, psz_value );
+                free( psz_extra_name );
             }
-            break;
         }
     }
-    vlc_mutex_unlock( &p_item->lock );
 
     /* Update selected program input info */
     if( p_pgrm == p_sys->p_pgrm )
-- 
2.39.1

