From ff144dfdb1f8046b32b92d574f37ed4c2c6ab444 Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Thu, 5 Feb 2026 02:03:29 +0900
Subject: [PATCH] =?UTF-8?q?fix:=20TS=E3=83=87=E3=83=9E=E3=83=AB=E3=83=81?=
 =?UTF-8?q?=E3=83=97=E3=83=AC=E3=82=AF=E3=82=B5=E3=81=8C=E9=AB=98=E9=80=9F?=
 =?UTF-8?q?=E3=82=B7=E3=83=BC=E3=82=AF=E3=81=A7=E3=81=8D=E3=81=AA=E3=81=84?=
 =?UTF-8?q?=E5=A0=B4=E5=90=88=E3=81=AB=E3=83=97=E3=83=AC=E3=82=A4=E3=83=A4?=
 =?UTF-8?q?=E3=83=BC=E3=81=AE=E4=BD=8D=E7=BD=AE=E8=A8=88=E7=AE=97=E3=82=92?=
 =?UTF-8?q?=E3=82=B9=E3=82=AD=E3=83=83=E3=83=97=E3=81=99=E3=82=8B=E3=82=88?=
 =?UTF-8?q?=E3=81=86=E4=BF=AE=E6=AD=A3?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/player/timer.c | 38 +++++++++++++++++++++++++++++++++++++-
 1 file changed, 37 insertions(+), 1 deletion(-)

diff --git a/src/player/timer.c b/src/player/timer.c
index 7448ac1b65..5751bf10dd 100644
--- a/src/player/timer.c
+++ b/src/player/timer.c
@@ -364,7 +364,43 @@ vlc_player_UpdateTimerSource(vlc_player_t *player,
     else
         source->point.system_date = system_date;

-    if (source->point.length != VLC_TICK_INVALID && !source->point.live)
+    struct vlc_player_input *input = player->input;
+    bool trust_demux_pos = false;
+
+    if (input && input->thread)
+    {
+        input_thread_private_t *priv = input_priv(input->thread);
+        if (priv->master && priv->master->p_demux)
+        {
+            demux_t *p_demux = priv->master->p_demux;
+            if (p_demux->psz_name)
+            {
+                if (strcmp(p_demux->psz_name, "ts") == 0)
+                {
+                    bool stream_can_fastseek = false;
+                    if (p_demux->s)
+                        vlc_stream_Control(p_demux->s, STREAM_CAN_FASTSEEK, &stream_can_fastseek);
+
+                    msg_Info(player, "TIMER: mpegts detected. stream_can_fastseek: %d", stream_can_fastseek);
+                    if (!stream_can_fastseek)
+                        trust_demux_pos = true;
+                }
+                else
+                {
+                    /* psz_name が異なる場合の確認用ログ */
+                    msg_Info(player, "TIMER: demuxer is not ts, but: %s", p_demux->psz_name);
+                }
+            }
+            else
+                msg_Info(player, "TIMER: p_demux->psz_name is NULL");
+        }
+        else
+            msg_Info(player, "TIMER: priv->master or p_demux is NULL");
+    }
+    else
+        msg_Info(player, "TIMER: input or input->thread is NULL");
+
+    if (!trust_demux_pos && source->point.length != VLC_TICK_INVALID && !source->point.live)
         source->point.position = (ts - player->timer.input_normal_time - player->timer.start_offset)
                                / (double) source->point.length;
     else
--
2.39.1

