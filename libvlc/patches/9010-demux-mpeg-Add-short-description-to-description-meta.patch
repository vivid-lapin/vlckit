From 950959878ca2c1d92ec0ca8f7bcb8f418650964b Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Sun, 15 Feb 2026 03:49:09 +0900
Subject: [PATCH] demux/mpeg: Add short description to description metadata

---
 modules/demux/mpeg/ts.c    |  8 ++++----
 modules/demux/mpeg/ts_si.c | 15 ++++++++++++++-
 src/input/es_out.c         | 35 +++++++++++++++++++++++++++++++++--
 3 files changed, 51 insertions(+), 7 deletions(-)

diff --git a/modules/demux/mpeg/ts.c b/modules/demux/mpeg/ts.c
index e63ad9f421..45e3323884 100644
--- a/modules/demux/mpeg/ts.c
+++ b/modules/demux/mpeg/ts.c
@@ -933,7 +933,7 @@ static int Control( demux_t *p_demux, int i_query, va_list args )
         pf = va_arg( args, double * );

         /* Access control test is because EPG for recordings is not relevant */
-        if( p_sys->b_access_control )
+        if( false && p_sys->b_access_control )
         {
             time_t i_time, i_length;
             if( !EITCurrentEventTime( p_pmt, p_sys, &i_time, &i_length ) && i_length > 0 )
@@ -976,7 +976,7 @@ static int Control( demux_t *p_demux, int i_query, va_list args )
         if(!p_sys->b_canseek)
             break;

-        if( p_sys->b_access_control &&
+        if( false && p_sys->b_access_control &&
            !p_sys->b_ignore_time_for_positions && b_bool && p_pmt )
         {
             time_t i_time, i_length = 0;
@@ -1033,7 +1033,7 @@ static int Control( demux_t *p_demux, int i_query, va_list args )
     }

     case DEMUX_GET_TIME:
-        if( p_sys->b_access_control )
+        if( false && p_sys->b_access_control )
         {
             time_t i_event_start;
             if( !EITCurrentEventTime( p_pmt, p_sys, &i_event_start, NULL ) )
@@ -1059,7 +1059,7 @@ static int Control( demux_t *p_demux, int i_query, va_list args )
         return VLC_SUCCESS;

     case DEMUX_GET_LENGTH:
-        if( p_sys->b_access_control )
+        if( false && p_sys->b_access_control )
         {
             time_t i_event_duration;
             if( !EITCurrentEventTime( p_pmt, p_sys, NULL, &i_event_duration ) )
diff --git a/modules/demux/mpeg/ts_si.c b/modules/demux/mpeg/ts_si.c
index a20b9fe971..dfeb102851 100644
--- a/modules/demux/mpeg/ts_si.c
+++ b/modules/demux/mpeg/ts_si.c
@@ -693,6 +693,7 @@ static void EITCallBack( void *opaque, dvbpsi_eit_t *p_eit )

     if( p_epg->i_event > 0 )
     {
+        p_epg->b_present = (p_eit->i_table_id == 0x4e);
         if( p_epg->b_present && p_epg->p_current )
         {
             ts_pat_t *p_pat = ts_pid_Get(&p_sys->pids, 0)->u.p_pat;
@@ -702,8 +703,20 @@ static void EITCallBack( void *opaque, dvbpsi_eit_t *p_eit )
                 p_pmt->eit.i_event_start = p_epg->p_current->i_start;
                 p_pmt->eit.i_event_length = p_epg->p_current->i_duration;
             }
+
+            vlc_meta_t *p_meta = vlc_meta_New();
+            if( p_meta )
+            {
+                if( p_epg->p_current->psz_name )
+                    vlc_meta_SetTitle( p_meta, p_epg->p_current->psz_name );
+                if( p_epg->p_current->psz_short_description )
+                    vlc_meta_SetDescription( p_meta, p_epg->p_current->psz_short_description );
+
+                es_out_Control( p_demux->out, ES_OUT_SET_GROUP_META,
+                                p_eit->i_extension, p_meta );
+                vlc_meta_Delete( p_meta );
+            }
         }
-        p_epg->b_present = (p_eit->i_table_id == 0x4e);
         es_out_Control( p_demux->out, ES_OUT_SET_GROUP_EPG, p_eit->i_extension, p_epg );
     }
     vlc_epg_Delete( p_epg );
diff --git a/src/input/es_out.c b/src/input/es_out.c
index 854940c1b3..338f2618b9 100644
--- a/src/input/es_out.c
+++ b/src/input/es_out.c
@@ -1654,14 +1654,18 @@ static void EsOutProgramSelect(es_out_sys_t *p_sys, es_out_pgrm_t *p_pgrm)
         {
              msg_Dbg( p_input, "EsOutProgramSelect: Setting Title to %s from ESNowPlaying", psz_nowplaying );
              input_item_SetTitle( input_priv(p_input)->p_item, psz_nowplaying );
+             input_item_SetMeta( input_priv(p_input)->p_item, vlc_meta_NowPlaying, psz_nowplaying );
         }
         else
         {
              const char *psz_title = vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Title );
              msg_Dbg( p_input, "EsOutProgramSelect: ESNowPlaying is NULL, using Title: %s", psz_title ? psz_title : "NULL" );
              input_item_SetTitle( input_priv(p_input)->p_item, psz_title );
+             input_item_SetMeta( input_priv(p_input)->p_item, vlc_meta_NowPlaying, psz_title );
         }

+        /* Force update notification */
+        input_item_SetPreparsed( input_priv(p_input)->p_item );
         EsOutMeta( p_sys, NULL, p_pgrm->p_meta );
         input_SendEventMeta( p_input );
         /* FIXME: we probably want to replace every input meta */
@@ -1901,9 +1905,16 @@ static void EsOutProgramMeta(es_out_sys_t *p_sys, input_source_t *source,
              * TODO update scrambled info name ? */
             free( psz_oldinfokey );
         }
-        vlc_meta_Delete( p_pgrm->p_meta );
+        /* Do not delete existing meta, as it may contain EIT info (ESNowPlaying, Description) set by EsOutProgramEpg */
+        /* vlc_meta_Delete( p_pgrm->p_meta ); */
+        msg_Dbg( p_input, "EsOutProgramMeta: p_pgrm->p_meta exists, merging new metadata (keeping EIT info)" );
+    }
+    else
+    {
+        msg_Dbg( p_input, "EsOutProgramMeta: p_pgrm->p_meta is NULL, creating new" );
+        p_pgrm->p_meta = vlc_meta_New();
     }
-    p_pgrm->p_meta = vlc_meta_New();
+
     if( p_pgrm->p_meta )
         vlc_meta_Merge( p_pgrm->p_meta, p_meta );

@@ -2041,10 +2052,14 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
         if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
         {
             const char *psz_name = ( p_tmp->p_current ) ? p_tmp->p_current->psz_name : NULL;
+            const char *psz_short_desc = ( p_tmp->p_current ) ? p_tmp->p_current->psz_short_description : NULL;
             if( !p_pgrm->p_meta )
                 p_pgrm->p_meta = vlc_meta_New();
             if( p_pgrm->p_meta )
+            {
                 vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
+                vlc_meta_Set( p_pgrm->p_meta, vlc_meta_Description, psz_short_desc );
+            }
             break;
         }
     }
@@ -2061,11 +2076,27 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
         {
             msg_Dbg( p_input, "EsOutProgramEpg: Setting Title to %s from ESNowPlaying", psz_nowplaying );
             input_item_SetMeta( input_priv(p_input)->p_item, vlc_meta_Title, psz_nowplaying );
+            input_item_SetMeta( input_priv(p_input)->p_item, vlc_meta_NowPlaying, psz_nowplaying );
         }
         else
         {
             msg_Dbg( p_input, "EsOutProgramEpg: ESNowPlaying is NULL, not setting Title" );
         }
+
+        const char *psz_desc = p_pgrm->p_meta ?
+                               vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Description ) : NULL;
+        if( psz_desc )
+        {
+            msg_Dbg( p_input, "EsOutProgramEpg: Setting Description to %s", psz_desc );
+            input_item_SetMeta( input_priv(p_input)->p_item, vlc_meta_Description, psz_desc );
+        }
+        else
+        {
+            msg_Dbg( p_input, "EsOutProgramEpg: Description is NULL" );
+        }
+
+        /* Force update notification even if already parsed */
+        input_item_SetPreparsed( p_item );
         input_SendEventMeta( p_input );

         const char *now_playing_tr =
--
2.39.1

