From 20dfdfb9f40c5a8303e48ed633710d4a506253a8 Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Mon, 16 Feb 2026 22:04:57 +0900
Subject: [PATCH] demux/mpeg: Mapping extra

---
 src/input/es_out.c | 100 ++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 98 insertions(+), 2 deletions(-)

diff --git a/src/input/es_out.c b/src/input/es_out.c
index be15fd2ca4..849efa922b 100644
--- a/src/input/es_out.c
+++ b/src/input/es_out.c
@@ -1978,6 +1978,49 @@ static void EsOutProgramEpgEvent(es_out_sys_t *p_sys, input_source_t *source,
     input_item_SetEpgEvent( p_item, p_event );
 }
 
+#define ARIB_META_EXTRA_PREFIX "ARIB:"
+
+static bool EsOutMetaExtraHasPrefix(const char *psz_name, const char *psz_prefix)
+{
+    return psz_name != NULL && psz_prefix != NULL &&
+           !strncmp(psz_name, psz_prefix, strlen(psz_prefix));
+}
+
+static void EsOutMetaClearPrefixedExtras(vlc_meta_t *p_meta, const char *psz_prefix)
+{
+    if( !p_meta )
+        return;
+
+    char **ppsz_names = vlc_meta_CopyExtraNames( p_meta );
+    if( !ppsz_names )
+        return;
+
+    for( int i = 0; ppsz_names[i] != NULL; i++ )
+    {
+        if( EsOutMetaExtraHasPrefix( ppsz_names[i], psz_prefix ) )
+            vlc_meta_SetExtra( p_meta, ppsz_names[i], NULL );
+        free( ppsz_names[i] );
+    }
+    free( ppsz_names );
+}
+
+static void EsOutInputItemClearPrefixedExtras(input_item_t *p_item, const char *psz_prefix)
+{
+    char **ppsz_names = NULL;
+    unsigned i_count = input_item_GetMetaExtraNames( p_item, &ppsz_names );
+    VLC_UNUSED(i_count);
+    if( !ppsz_names )
+        return;
+
+    for( int i = 0; ppsz_names[i] != NULL; i++ )
+    {
+        if( EsOutMetaExtraHasPrefix( ppsz_names[i], psz_prefix ) )
+            input_item_SetMetaExtra( p_item, ppsz_names[i], NULL );
+        free( ppsz_names[i] );
+    }
+    free( ppsz_names );
+}
+
 static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
                             int i_group, const vlc_epg_t *p_epg)
 {
@@ -2022,14 +2065,46 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
 
         if( p_tmp->b_present && p_tmp->i_source_id == p_pgrm->i_id )
         {
-            const char *psz_name = ( p_tmp->p_current ) ? p_tmp->p_current->psz_name : NULL;
-            const char *psz_short_desc = ( p_tmp->p_current ) ? p_tmp->p_current->psz_short_description : NULL;
+            const vlc_epg_event_t *p_current = p_tmp->p_current;
+            const char *psz_name = ( p_current ) ? p_current->psz_name : NULL;
+            const char *psz_short_desc = ( p_current ) ? p_current->psz_short_description : NULL;
             if( !p_pgrm->p_meta )
                 p_pgrm->p_meta = vlc_meta_New();
             if( p_pgrm->p_meta )
             {
+                char psz_date[64];
+
                 vlc_meta_Set( p_pgrm->p_meta, vlc_meta_ESNowPlaying, psz_name );
                 vlc_meta_Set( p_pgrm->p_meta, vlc_meta_Description, psz_short_desc );
+                if( p_current != NULL )
+                {
+                    snprintf( psz_date, sizeof(psz_date),
+                              "start=%"PRId64";duration=%"PRIu32,
+                              p_current->i_start, p_current->i_duration );
+                    vlc_meta_SetDate( p_pgrm->p_meta, psz_date );
+                }
+                else
+                {
+                    vlc_meta_SetDate( p_pgrm->p_meta, NULL );
+                }
+
+                EsOutMetaClearPrefixedExtras( p_pgrm->p_meta, ARIB_META_EXTRA_PREFIX );
+                if( p_current != NULL )
+                {
+                    for( int j = 0; j < p_current->i_description_items; j++ )
+                    {
+                        const char *psz_key = p_current->description_items[j].psz_key;
+                        const char *psz_value = p_current->description_items[j].psz_value;
+                        char *psz_extra_name = NULL;
+
+                        if( psz_key == NULL || psz_value == NULL || *psz_key == '\0' )
+                            continue;
+                        if( asprintf( &psz_extra_name, ARIB_META_EXTRA_PREFIX "%s", psz_key ) < 0 )
+                            continue;
+                        vlc_meta_SetExtra( p_pgrm->p_meta, psz_extra_name, psz_value );
+                        free( psz_extra_name );
+                    }
+                }
             }
             break;
         }
@@ -2048,11 +2123,32 @@ static void EsOutProgramEpg(es_out_sys_t *p_sys, input_source_t *source,
         const char *psz_desc = p_pgrm->p_meta ?
                                vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Description ) : NULL;
         input_item_SetDescription( input_priv(p_input)->p_item, psz_desc );
+        input_item_SetDate( input_priv(p_input)->p_item,
+                            p_pgrm->p_meta ? vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Date ) : NULL );
 
         /* Also propagate Publisher (service name from SDT) if available */
         const char *psz_pub = p_pgrm->p_meta ?
                               vlc_meta_Get( p_pgrm->p_meta, vlc_meta_Publisher ) : NULL;
         input_item_SetPublisher( input_priv(p_input)->p_item, psz_pub );
+
+        EsOutInputItemClearPrefixedExtras( input_priv(p_input)->p_item, ARIB_META_EXTRA_PREFIX );
+        if( p_pgrm->p_meta )
+        {
+            char **ppsz_extra_names = vlc_meta_CopyExtraNames( p_pgrm->p_meta );
+            if( ppsz_extra_names )
+            {
+                for( int i = 0; ppsz_extra_names[i] != NULL; i++ )
+                {
+                    if( EsOutMetaExtraHasPrefix( ppsz_extra_names[i], ARIB_META_EXTRA_PREFIX ) )
+                    {
+                        input_item_SetMetaExtra( input_priv(p_input)->p_item, ppsz_extra_names[i],
+                                                 vlc_meta_GetExtra( p_pgrm->p_meta, ppsz_extra_names[i] ) );
+                    }
+                    free( ppsz_extra_names[i] );
+                }
+                free( ppsz_extra_names );
+            }
+        }
         input_SendEventMeta( p_input );
 
         const char *now_playing_tr =
-- 
2.39.1

