From 56d488304e59edb43e1b8e38db15bb4673cacf56 Mon Sep 17 00:00:00 2001
From: ci7lus <7887955+ci7lus@users.noreply.github.com>
Date: Sun, 15 Feb 2026 00:27:22 +0900
Subject: [PATCH] demug/mpeg: fix ARIB-STD-B24 string decoder

---
 modules/demux/mpeg/ts_arib.c | 161 ++++++++++++++++++-----------------
 1 file changed, 82 insertions(+), 79 deletions(-)

diff --git a/modules/demux/mpeg/ts_arib.c b/modules/demux/mpeg/ts_arib.c
index 6fccbf0c42..3f4f221262 100644
--- a/modules/demux/mpeg/ts_arib.c
+++ b/modules/demux/mpeg/ts_arib.c
@@ -302,6 +302,82 @@ static void get_sjis_kanji( uint8_t b1, uint8_t b2, uint8_t res[2] )
     res[1] = (b2 + cell) & 0xFF;
 }
 
+static void ts_arib_process_gl( arib_parser_t *p_ctx, uint8_t c,
+                                const uint8_t *p_in, size_t i_in, size_t *pi,
+                                struct vlc_memstream *p_stream,
+                                uint8_t **pp_sjis, size_t *pi_sjis, size_t *pi_sjis_alloc,
+                                bool b_graphic_normal )
+{
+    uint8_t set_idx = p_ctx->graphic_l;
+    if( p_ctx->graphic_mode[set_idx] != MODE_GRAPHIC )
+    {
+        /* Invalid mode for GL, skip char(s) */
+        if( p_ctx->graphic_byte[set_idx] == 2 && *pi < i_in ) (*pi)++;
+    }
+    else
+    {
+        uint8_t cs = p_ctx->graphic[set_idx];
+
+        if( p_ctx->graphic_byte[set_idx] == 2 )
+        {
+             /* 2-byte GL */
+             uint8_t c2 = (*pi < i_in) ? p_in[(*pi)++] : 0;
+             if( !c2 ) return;
+
+             /* Kanji / Gaiji Handling */
+             uint16_t code = (c << 8) | c2;
+
+             arib_map_str_t *p_map = bsearch( &code, arib_gaiji_map, arib_gaiji_map_count,
+                                              sizeof(arib_map_str_t), cmp_u16_str );
+             if( p_map )
+             {
+                 arib_flush( p_stream, pp_sjis, pi_sjis );
+                 vlc_memstream_puts( p_stream, p_map->val );
+             }
+             else
+             {
+                 uint8_t sjis[2];
+                 get_sjis_kanji( c, c2, sjis );
+                 arib_buf_append( pp_sjis, pi_sjis, pi_sjis_alloc, sjis[0], sjis[1] );
+             }
+        }
+        else
+        {
+            /* 1-byte GL */
+            const arib_map_sjis_t *p_el = NULL;
+            uint8_t val[2] = {0};
+
+            if( cs == CS_ASCII || cs == CS_PROP_ASCII || cs == CS_JIS_X0201_KATAKANA )
+            {
+                if( b_graphic_normal )
+                     p_el = bsearch( &c, arib_ascii_map, arib_ascii_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
+                else
+                     val[0] = c;
+            }
+            else if( cs == CS_HIRAGANA || cs == CS_PROP_HIRAGANA )
+            {
+                p_el = bsearch( &c, arib_hiragana_map, arib_hiragana_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
+            }
+            else if( cs == CS_KATAKANA || cs == CS_PROP_KATAKANA )
+            {
+                p_el = bsearch( &c, arib_katakana_map, arib_katakana_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
+            }
+
+            if( p_el )
+            {
+                val[0] = p_el->val[0];
+                val[1] = p_el->val[1];
+            }
+            else if( !val[0] && b_graphic_normal && cs == CS_ASCII )
+            {
+                val[0] = c;
+            }
+
+            arib_buf_append( pp_sjis, pi_sjis, pi_sjis_alloc, val[0], val[1] );
+        }
+    }
+}
+
 char * ts_arib_Decode( const uint8_t *p_in, size_t i_in )
 {
     if( !p_in || !i_in ) return NULL;
@@ -363,8 +439,8 @@ char * ts_arib_Decode( const uint8_t *p_in, size_t i_in )
                         if ( next_c > 0x20 && next_c <= 0x7E )
                         {
                             i++;
-                            c = next_c;
-                            goto process_gl;
+                            ts_arib_process_gl( &ctx, next_c, p_in, i_in, &i, &stream,
+                                                &p_sjis, &i_sjis, &i_sjis_alloc, b_graphic_normal );
                         }
                     }
                     ctx.graphic_l = saved_l;
@@ -384,8 +460,8 @@ char * ts_arib_Decode( const uint8_t *p_in, size_t i_in )
                         if ( next_c > 0x20 && next_c <= 0x7E )
                         {
                             i++;
-                            c = next_c;
-                            goto process_gl;
+                            ts_arib_process_gl( &ctx, next_c, p_in, i_in, &i, &stream,
+                                                &p_sjis, &i_sjis, &i_sjis_alloc, b_graphic_normal );
                         }
                     }
                     ctx.graphic_l = saved_l;
@@ -464,81 +540,8 @@ char * ts_arib_Decode( const uint8_t *p_in, size_t i_in )
         }
         else if( c <= 0x7E ) /* GL */
         {
-process_gl: /* Label for SS2/SS3 goto */
-            {
-                uint8_t set_idx = ctx.graphic_l;
-                if( ctx.graphic_mode[set_idx] != MODE_GRAPHIC )
-                {
-                    /* Invalid mode for GL, skip char(s) */
-                    if( ctx.graphic_byte[set_idx] == 2 && i < i_in ) i++;
-                }
-                else
-                {
-                    uint8_t cs = ctx.graphic[set_idx];
-
-                    if( ctx.graphic_byte[set_idx] == 2 )
-                    {
-                         /* 2-byte GL */
-                         uint8_t c2 = (i < i_in) ? p_in[i++] : 0;
-                         if( !c2 ) break;
-
-                         /* Kanji / Gaiji Handling */
-                         /* Check Gaiji range (JIS Row-Cell) */
-                         uint16_t code = (c << 8) | c2;
-
-                         /* Check ARIB Gaiji Map */
-                         arib_map_str_t *p_map = bsearch( &code, arib_gaiji_map, arib_gaiji_map_count,
-                                                          sizeof(arib_map_str_t), cmp_u16_str );
-                         if( p_map )
-                         {
-                             arib_flush( &stream, &p_sjis, &i_sjis );
-                             vlc_memstream_puts( &stream, p_map->val );
-                         }
-                         else
-                         {
-                             uint8_t sjis[2];
-                             get_sjis_kanji( c, c2, sjis );
-                             arib_buf_append( &p_sjis, &i_sjis, &i_sjis_alloc, sjis[0], sjis[1] );
-                         }
-                    }
-                    else
-                    {
-                        /* 1-byte GL */
-                        /* Lookup in tables based on CS */
-                        const arib_map_sjis_t *p_el = NULL;
-                        uint8_t val[2] = {0};
-
-                        if( cs == CS_ASCII || cs == CS_PROP_ASCII || cs == CS_JIS_X0201_KATAKANA )
-                        {
-                            if( b_graphic_normal )
-                                 p_el = bsearch( &c, arib_ascii_map, arib_ascii_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
-                            else
-                                 val[0] = c; /* Just ASCII 1-byte? Or mapped? */
-                        }
-                        else if( cs == CS_HIRAGANA || cs == CS_PROP_HIRAGANA )
-                        {
-                            p_el = bsearch( &c, arib_hiragana_map, arib_hiragana_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
-                        }
-                        else if( cs == CS_KATAKANA || cs == CS_PROP_KATAKANA )
-                        {
-                            p_el = bsearch( &c, arib_katakana_map, arib_katakana_map_count, sizeof(arib_map_sjis_t), cmp_u8_sjis );
-                        }
-
-                        if( p_el )
-                        {
-                            val[0] = p_el->val[0];
-                            val[1] = p_el->val[1];
-                        }
-                        else if( !val[0] && b_graphic_normal && cs == CS_ASCII )
-                        {
-                            /* Fallback to normal ascii if not in map (map has 0x21+) */
-                            val[0] = c;
-                        }
-
-                        arib_buf_append( &p_sjis, &i_sjis, &i_sjis_alloc, val[0], val[1] );
-                    }
-                }
-            }
+            ts_arib_process_gl( &ctx, c, p_in, i_in, &i, &stream,
+                                &p_sjis, &i_sjis, &i_sjis_alloc, b_graphic_normal );
         }
         else if( c <= 0xA0 ) /* C1 */
         {
-- 
2.39.1

